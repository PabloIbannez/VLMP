#!/home/pablo/py3/bin/python
####!/home/pablo/anaconda3/bin/python
import sys,os
import shutil

import argparse

import json

import itertools

import logging

import psutil
import signal

import multiprocessing
import subprocess

import time
import datetime

################

gpuIDList = []

if os.uname()[1] == "pablo-HOME":
    gpuIDList = [0]
if os.uname()[1] == "compute-new":
    gpuIDList = [0,1,2,3,5]
if os.uname()[1] == "compute-0-3.local":
    gpuIDList = [0,1,2,3]
if os.uname()[1] == "compute-0-4.local":
    gpuIDList = [0,1,2,3]

nodeGPUList = []
if os.uname()[1] == "pablo-HOME":
    #Order matters
    nodeGPUList = itertools.cycle([1,2,3,4,5,6,7,8])
if os.uname()[1] == "liquid.ftmc.uam.es":
    #Order matters
    #nodeGPUList = itertools.cycle([7,7,7,7,9,9,9,9,10,10,10,10,12,12,12,8,8,8,8])
    nodeGPUList = itertools.cycle([7,7,7,7,9,9,9,9,10,10,10,10,12,12,12])

#################

def signalHandler(sig,frame):
    logging.info("Signal {} detected. Exiting ...".format(sig))

    mainProcess = psutil.Process(os.getpid())
    for child in mainProcess.children(recursive=True):
        child.kill()

    sys.exit(0)

def associateCPUtoGPU(gpuIDList):
    cpuName = multiprocessing.current_process().name
    try:
        cpuID = int(cpuName[cpuName.find('-') + 1:]) - 1
    except:
        cpuID = 0
    gpuID = gpuIDList[cpuID % len(gpuIDList)]
    return gpuID

def runSimulation(simulationsInfo, setInfo, gpuIDList):

    name, folder, options, components = setInfo

    gpuId = associateCPUtoGPU(gpuIDList)
    cudaFlag = 'CUDA_VISIBLE_DEVICES={}'.format(gpuId)

    fout = open(folder+"/stdout.log","w")
    ferr = open(folder+"/stderr.log","w")

    sst = time.time()

    sim = " ".join([cudaFlag, " ".join(["UAMMDlauncher",options])])
    simReturn = subprocess.run(sim, stdout=fout, stderr=ferr, shell=True, cwd=folder)

    fout.close()
    ferr.close()

    if simReturn.returncode == 0:
        logging.info("Simulation {} finished. Total time: {}".format(folder,
                                                                     str(datetime.timedelta(seconds=(time.time() - sst)))))
    else:
        logging.info("Simulation {} finished with errors. Error code: {}. Total time: {}".format(folder,
                                                                                                 simReturn.returncode,
                                                                                                 str(datetime.timedelta(seconds=(time.time() - sst)))))
    return simReturn

def runSimulationSets(logging, simulationsInfo, simulationSets, gpuIDList):

    with multiprocessing.Pool(processes=len(gpuIDList)) as pool:
        simSetGPU = tuple(zip(itertools.repeat(simulationsInfo.copy()),simulationSets,itertools.repeat(gpuIDList)))
        out = list(pool.starmap(runSimulation,simSetGPU))

    return out

def mainLocal(simulationSetsInfo):

    with open(simulationSetsInfo,"r") as f:
        simulationSetsInfo = json.load(f)

    simulationName  = simulationSetsInfo["name"]
    simulationsInfo = simulationSetsInfo["simulations"]
    simulationSets  = simulationSetsInfo["simulationSets"]

    logging.basicConfig(filename=f'{simulationName}.log',
                        filemode='w',
                        level=0,
                        format='%(asctime)s %(levelname)s: %(message)s',
                        datefmt='%m/%d/%Y %H:%M:%S')

    logging.info("Start local ...")
    logging.info("pid: {}".format(os.getpid()))

    signal.signal(signal.SIGINT,signalHandler)
    signal.signal(signal.SIGTERM,signalHandler)

    st = time.time()
    out = runSimulationSets(logging,simulationsInfo,simulationSets,gpuIDList)
    logging.info("Simulation sets finished. Total time: {}".format(str(datetime.timedelta(seconds=(time.time() - st)))))

    for i in out:
        if(i.returncode!=0):
            logging.error("Something went wrong for simulation: {}".format(i))

    logging.info("End")

def mainLiquid(simulationSetsInfo):

    user = os.environ.get("USER")

    with open(simulationSetsInfo,"r") as f:
        simulationSetsInfo = json.load(f)

    simulationName  = simulationSetsInfo["name"]
    simulationsInfo = simulationSetsInfo["simulations"]
    simulationSets  = simulationSetsInfo["simulationSets"]

    logging.basicConfig(filename=f'{simulationName}.log',
                        filemode='w',
                        level=0,
                        format='%(asctime)s %(levelname)s: %(message)s',
                        datefmt='%m/%d/%Y %H:%M:%S')

    logging.info("Starting liquid ...")

    for jobIndex,[simSetName,simSetFolder,simSetOptions,simSetComponents] in enumerate(simulationSets):
        nodeId = next(nodeGPUList)
        jobName = f"{simulationName}_{simSetName}"

        logging.info(f'Launching simulation ...\n\
                          Job name: \"{jobName}\"\n\
                          Simulation folder: \"{simSetFolder}\"\n\
                          Binary: \"UAMMDlauncher\"\n\
                          Simulation options: \"{simSetOptions}\"\n\
                          Node: compute-0-{nodeId}')

        ############################################################

        cwd = os.getcwd()
        os.chdir(simSetFolder)

        with open("./.job","w") as f:
            batch = ("#!/bin/bash\n"
                     "#$ -S /bin/bash\n"
                     f"#$ -N {jobName}\n"
                     "#$ -cwd\n"
                     "#$ -o stdout.log\n"
                     "#$ -e stderr.log\n"
                     "#$ -l gpu=1\n"
                     "#$ -V\n"
                     f"cd /scratch/{user}/{jobName}-$JOB_ID\n"
                     "module load gcc/8.4 cuda/10.2\n"
                     f"UAMMDlauncher {simSetOptions}\n")

            f.write(batch)

        subprocess.run(["bsub","-N",jobName,
                        "-q","gpu.q",
                        "-l",f"hostname=compute-0-{nodeId}",
                        "-o",f"{os.getcwd()}/stdout.log",
                        "-e",f"{os.getcwd()}/stderr.log",
                        ".job"])
        time.sleep(1.0)
        os.chdir(cwd)

        ############################################################
    
    logging.info("All simulation sets job have been submitted")


if __name__ == "__main__":

    #Create argument parser
    parser = argparse.ArgumentParser(description='Run a set of simulations')

    #Add arguments
    parser.add_argument('-s', '--simulationSetsInfo', type=str, help='Simulation sets info file', required=True)

    #There are two simualtions options, local and liquid (cluster lsf). If none is selected, local is used.
    #Add mutually exclusive group
    group = parser.add_mutually_exclusive_group()
    group.add_argument('-l', '--local', action='store_true', help='Run simulations locally')
    group.add_argument('-q', '--liquid', action='store_true', help='Run simulations in liquid cluster')

    #Parse arguments
    args = parser.parse_args()

    #Start VLMP

    print("Starting VLMP ...")

    if args.local or not args.liquid:
        print("Running simulations locally ...")
        child_pid = os.fork()

        if child_pid == 0:
            mainLocal(args.simulationSetsInfo)
        else:
            sys.exit(0)
    else:
        print("Running simulations in liquid cluster ...")
        mainLiquid(args.simulationSetsInfo)
